---
# tasks file for tarball tests
  - name: Add specified repository into sources list
    ansible.builtin.apt_repository:
      repo: ppa:deadsnakes/ppa
      state: present
    when: ansible_os_family == "Debian"

  - name: install needed packages for running tests with apt
    apt:
      name: "{{ packages }}"
      update_cache: yes
      state: latest
    vars:
      packages:
      - git
      - wget
      - python3.6 
      - sudo python3 get-pip.py
      - libaio1 
      - libnuma1
    retries: 60
    delay: 10
    register: result
    until: result is not failed
    when: ansible_os_family == "Debian"

  - name: install needed packages for running tests with yum
    yum:
      name: "{{ packages }}"
      state: latest
    vars:
      packages:
      - git
      - unzip
      - wget
      - libaio
      - numactl
      - openssl
      - tar
      - perl-Data-Dumper
      - epel-release
      - python3
      - python3-pip
    when: ansible_os_family == "RedHat"

  - name: assign minimal value
    set_fact:
      MINIMAL:  "{{ '-minimal' if lookup('env', 'BUILD_TYPE_MINIMAL') == True else '' }}"

  - name: get GLIBC_VERSION
    set_fact:
      GLIBC_VERSION: "{{ '2.35' if ansible_os_family == 'Debian' else '2.34' }}"
  
  - name: get TARBALL_NAME
    set_fact:
      TARBALL_NAME: " Percona-Server-Pro-{{ lookup('env', 'PS_VERSION') }}-Linux.x86_64.glibc{{ GLIBC_VERSION }}{{ MINIMAL }}.tar.gz"

  - name: get TARBALL_LINK
    set_fact:
      TARBALL_LINK: "https://repo.percona.com/private/{{ lookup('env', 'USERNAME') }}-{{ lookup('env', 'PASSWORD') }}/ps-80-pro/tarballs/Percona-Server-8.0.35-27/Percona-Server-{{ lookup('env', 'PS_VERSION') }}/"

  - name: download package-testing repo branch with wget
    command: "{{ item }}"
    with_items:
    - rm -rf package-testing
    - rm -f master.zip
    - wget --no-check-certificate -O master.zip https://github.com/eleo007/package-testing/archive/pro_build_job.zip
    - unzip master.zip
    - rm -f master.zip
    - mv package-testing-pro_build_job package-testing

  - name: Download tarball for ol9 from url
    get_url:
      url: '{{ TARBALL_LINK }}'
      dest: package-testing/binary-tarball-tests/ps
      mode: '0644'

  - name: Unpack new tarball
    unarchive:
      src: package-testing/binary-tarball-tests/ps
      dest: package-testing/binary-tarball-tests/ps
      remote_src: yes